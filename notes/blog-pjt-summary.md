---
title: GitHub Pages+Next.jsでブログを構築する
tags: [next.js]
published_at: 2022-07-14T17:53:53+09:00[Asia/Tokyo]
---

うおおおおおおおおおお！！！先々週までこんな感じだったブログが…

![2週間前のスクショ](blog-20220702.png "7月2日当時のスクショ。文字が書いてあるのでブログ")

原稿パーサーとReact側の改善により、まともになりました。

![本日のスクショ](blog-20220715.png "デザインのクオリティはさておき、ブログっぽい")

## tl;dr;

GitHubにほぼ頼りきりのブログができたよ

### 使った技術スタック

-   Next.js (SSG)
-   PEG.js (自前マークダウン風のパーサー)
-   GitHub Action ビルド
-   GitHub Pages ホスト
-   Cloudflare（現状ただ置いただけ）
-   全自動OGP画像でっち上げ機能

この記事では主にパーサーと、OGP画像と、GitHub ActionによるPages更新について触れます。

## パーサー開発

まず前半はマークダウンの仕様決めとパーサー開発から進めました。マークダウンの仕様さえ決まれば記事は書けるので、「とりあえず仕様を決めて、記事を書いて、後からパースして、さらに後から体裁を整える」という流れで作業を進めています。

パーサーの作業時間は[この記事](/blog-pjt-005-markdown)あたりにありますが、意外とシュッと書けましたね。もろもろ合計しても「とりあえず動く」まで半日から1日くらいでしょうか。

### PEG

PEG ([Parsing Expression Grammar](https://ja.wikipedia.org/wiki/Parsing_Expression_Grammar)) は、入力された文字列を先頭からどう解釈していくかという規則を宣言的に書いたもの…　だと思う…　私も正直ちゃんと理論的背景を把握してないから「なんかそうだと思う」としか言えないのだけど… 実際に[オンラインのデモ](https://pegjs.org/online)を触ってみると取っ付きやすいと思います。

このブログでは、PEGを中心として以下のような実装になりました。

-   [`parse.pegjs`](https://github.com/stakme/stakme.github.io/blob/main/src/query/parse.pegjs): PEGで書かれたパーサー
-   `parse.js`: 自動生成コード。gitignoreしておく
-   [`parse.d.ts`](https://github.com/stakme/stakme.github.io/blob/main/src/query/parse.d.ts): 自動生成コードをTypeScriptで使うために型をつける
-   [`convert.ts`](https://github.com/stakme/stakme.github.io/blob/main/src/query/convert.ts): リスト表記のパース結果をネストしたオブジェクトに変換する君
    -   実際に吐き出すhtmlを想定すると、ネスト構造をしているほうが楽
-   [`index.ts`](https://github.com/stakme/stakme.github.io/blob/main/src/query/index.ts): マークダウンとhtmlの間をつなぐ君
    -   convertかける
    -   画像サイズをsharpで測って詰める (Next.jsの都合で必要)
    -   OGP画像を生成する

パーサーはその後も色々と手を入れていますが、[実際の原稿ファイル](https://raw.githubusercontent.com/stakme/stakme.github.io/6aa9f3033c5ea3ed967abb0e03b1a1838183c64f/notes/blog-pjt-top-page.md)は最初に構想したものとほとんど同じです。日付文字列のフォーマットがちょっと変わったくらいかな…　冒頭だけ抜き出すと、こんな感じで書いてあります。

```
---
summary: トップページつくった
tags: [next.js]
published_at: 2022-07-02T00:29:51+09:00[Asia/Tokyo]
---

トップページに遷移できるようになりました。まるでWebサイトみたいだ…

### pjt.init

-   goal: サイト利用者からみて、コンテンツが現実的に利用可能な状態する
-   measurable objectives:
    1. stak.me にアクセスすると、直近の記事タイトル、本文、投稿日時が表示されている
    1. 各記事にサイト名が表示されている
    1. トップと記事でリンク遷移できる
```

パーサーの作り方次第ですが、今回の場合は「人間が間違えるとすぐ死ぬ」パーサーになっています。「メタデータの具体的なキーが一致しないと死ぬ」とか「想定外の改行記号があると死ぬ」というような挙動をしております。そういう入力を許容することも当然できますが、私の曖昧な入力を許容するメリットは１個も思い浮かばなかったので、想定外のインプットなら死んでもらいます。

### 現状とTODO

ところで上掲の原稿、一見すると普通のマークダウン風ですが、あくまで「マークダウン風」の別物です。パーサー自体の実装と、その後の処理の流れから、通常の世界には存在しないルールがあります。例えば…

-   記事冒頭はYAML形式のメタデータでなければならない
-   メタデータは特定キーを含む辞書でなければならない
-   `![わんわん🐶](dog.jpeg)` と記載すると `/{記事ID}/dog.jpeg` にある画像を表示する
-   さらに `![@わんわん🐶](dog.jpeg)` と記載すると「この記事を代表する画像」として取り扱う（トップページやTwitter Cardに出したりする）

未実装の機能も色々あります。文字列を強調する `**` だとか、打ち消し線を乗せる `~~` などは実装されていません。テーブル記法とかもないです。ツイート埋め込み機能とか、`pre`タグに書かれたコードにいい感じのシンタックスハイライトを当てる機能とかもないです。テーブル記法は多分しばらく（一生かも）対応しない気がしますが、シンタックスハイライトは早めに入れたいですね。ある方が見やすい。

あとカッコイイから。カッコイイのは大事。

![@わんわん🐶](dog.jpeg "ここで突如、記事となんの関係もない我が家の犬をご覧ください")

## OGP画像の生成

ひとことで言うと[`node-canvas`](https://github.com/Automattic/node-canvas)で[頑張って作っています](https://github.com/stakme/stakme.github.io/blob/6aa9f3033c5ea3ed967abb0e03b1a1838183c64f/src/utils/image.ts)。おわり。

これほぼTwitter Cardのために作った機能なんですが、クリックレート向上にどのくらい寄与するのかは未知数です。謎い。

明確な課題として、自然な改行を入れてあげることができないため、タイトルが長い場合は人力で「改行ありバージョン」のタイトルを書く必要があります。面倒すぎて絶対にワークしないやつなので改善したい気はしつつ… OGP画像に効果があるならそのうちやるのかなー。

## GitHub Action + Pages

インターネットを見ると「GitHub Actionでビルドしたあと、成果物を`gh-pages`ブランチにコミットして公開する」というアプローチが多そうです。

結論からいうと、`actions/deploy-pages`を使うことで「GitHub Actionから成果物を直接アップロード」という[処理が書けます](https://github.com/stakme/stakme.github.io/blob/6aa9f3033c5ea3ed967abb0e03b1a1838183c64f/.github/workflows/gh-pages.yml)。

ただ、書けば最終的には動くんですが、なんかめちゃくちゃ罠がいっぱいあるので正直まだ微妙です。[処理が書けることをドキュメントに記載しようというPR](https://github.com/actions/deploy-pages/pull/35)も出ていますが、GitHub側の変更待ちというステータスになっているっぽい。ただし罠についてはPRで丁寧に説明されているので、やってやるぜ！という方はPR見ながら弄ればそんなに苦労することはないと思います。

一点注意すべきこととしては、どうも現状「CNAMEファイルの存否だけは、アップロードされたartifactではなく対象ブランチを見ている」っぽいです。なのでCNAME設定して独自ドメインを使いたいときは「gh-pagesブランチにもCNAMEファイルをきちんと設置する」という作業が必要っぽいです。

## 作ってみて感想

Next.jsのとっつきやすさは素晴らしいです。SPAっぽいものをゼロから書くのは久しぶりですが、罠らしい罠もないし、ドキュメントは充実しているし、TypeScriptとの相性もいいし。もう全部これでいいんじゃないかなってなっちゃった。すげえよ。
